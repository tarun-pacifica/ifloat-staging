<%= partial "cached_finds/find_header" %>

<div id="future_purchase_options">
	<% unless @shopping_list.empty? %>
	<table class="shopping_list">
		<tr>
			<th>Shopping List</th>
			<td> </td>
			<% @facility_urls.each do |url| %>
			<td class="facility"> <img src="/images/estore_logos/<%= url %>.png" alt=<%= url.inspect %> /> </td>
			<% end %>
		</tr>
		
		<tr class="separator"> <td colspan="<%= (2 + @facility_urls.size) %>"></td> </tr>
		
		<% @shopping_list.each do |purchase| %>
		<% prices = (@prices_by_url_by_product_id[purchase.definitive_product_id] || {}) %>
		<tr>
			<td class="move">
				<a href="#" onclick="future_purchase_opts_move(<%= purchase.id %>)">
					<p>Move to Future Buys</p> <img src="/images/buttons/arrow_down.png" />
				</a>
			</td>
			<td class="product" id="prod_<%= purchase.definitive_product_id %>"> </td>
			<% @facility_urls.each do |url| %>
			<td class="price"><%= money(prices[url]) || "Not currently in stock" %></td>
			<% end %>
		</tr>
		<% end %>
		
		<tr class="total">
			<th colspan="2">Totals</th>
			<% @facility_urls.each do |url| %>
			<% facility_id, count, total = @totals_info[url] %>
			<td class="buy">
				<% if count.zero? %>
					No items to buy
				<% else %>
					<a href="/future_purchases/buy/<%= facility_id %>">Buy <%= count %> item<%= count == 1 ? '' : 's' %> for <%= money(total) %></a>
				<% end%>
			</td>
			<% end %>
		</tr>
	</table>
	<% end %>
	
	<% unless @future_buys.empty? %>
	<table class="future_buys">
		<tr> <th>Future Buys</th> </tr>
		<tr class="separator"> <td colspan="3"></td> </tr>
		
		<% @future_buys.each do |purchase| %>
		<% prices = (@prices[purchase.definitive_product_id] || {}) %>
		<tr>
			<td class="move">
				<a href="#" onclick="future_purchase_opts_move(<%= purchase.id %>)">
					<p>Move to Shopping List</p> <img src="/images/buttons/arrow_up.png" />
				</a>
			</td>
			<td class="product" id="prod_<%= purchase.definitive_product_id %>"> </td>
			<td class="price">
				<% min_price, max_price = prices.values.minmax %>
				<% if min_price.nil? %>
					None of our partners currently have this item in stock
				<% else %>
					<%= [min_price, max_price].uniq.map { |amount| money(amount) }.join(" &ndash; ") %>
				<% end %>
			</td>
		</tr>
		<% end %>
		
		<tr class="total"> <th colspan="3"></th> </tr>
	</table>
	<% end %>
</div>

<div id="future_purchase_options_tmp"> </div>

<script type="text/javascript" charset="utf-8">
	future_purchase_opts_load(<%= @product_ids.inspect %>);
</script>